package com.siasun.dianshi.mapviewdemo.ui

import android.app.ActivityManager
import android.content.Context
import android.graphics.PointF
import android.os.Build
import android.os.Bundle
import android.util.Log
import androidx.annotation.RequiresApi
import androidx.lifecycle.lifecycleScope
import com.blankj.utilcode.util.ToastUtils
import com.jeremyliao.liveeventbus.LiveEventBus
import com.ngu.lcmtypes.laser_t
import com.ngu.lcmtypes.robot_control_t
import com.siasun.dianshi.AreaType
import com.siasun.dianshi.ConstantBase
import com.siasun.dianshi.ConstantBase.PAD_WORLD_NAME
import com.siasun.dianshi.ConstantBase.getFolderPath
import com.siasun.dianshi.base.BaseMvvmActivity
import com.siasun.dianshi.bean.CleanAreaNew
import com.siasun.dianshi.bean.CmsStation
import com.siasun.dianshi.bean.PlanPathResult
import com.siasun.dianshi.bean.PositingArea
import com.siasun.dianshi.bean.SpArea
import com.siasun.dianshi.bean.TeachPoint
import com.siasun.dianshi.bean.WorkAreasNew
import com.siasun.dianshi.bean.pp.world.PathIndex
import com.siasun.dianshi.controller.MainController
import com.siasun.dianshi.framework.ext.onClick
import com.siasun.dianshi.framework.ext.toBean
import com.siasun.dianshi.framework.ext.toJson
import com.siasun.dianshi.framework.log.LogUtil
import com.siasun.dianshi.mapviewdemo.CLEAN_PATH_PLAN
import com.siasun.dianshi.mapviewdemo.KEY_AGV_COORDINATE
import com.siasun.dianshi.mapviewdemo.KEY_BOTTOM_CURRENT_POINT_CLOUD
import com.siasun.dianshi.mapviewdemo.KEY_CURRENT_POINT_CLOUD
import com.siasun.dianshi.mapviewdemo.KEY_POSITING_AREA_VALUE
import com.siasun.dianshi.mapviewdemo.KEY_TEACH_PATH
import com.siasun.dianshi.mapviewdemo.KEY_UPDATE_PLAN_PATH_RESULT
import com.siasun.dianshi.mapviewdemo.PATH_MODE
import com.siasun.dianshi.mapviewdemo.TAG_PP
import com.siasun.dianshi.mapviewdemo.TEACH_PATH_PLAN
import com.siasun.dianshi.mapviewdemo.databinding.ActivityShowMapViewBinding
import com.siasun.dianshi.mapviewdemo.utils.GsonUtil
import com.siasun.dianshi.mapviewdemo.utils.PathPlanningUtil1
import com.siasun.dianshi.mapviewdemo.viewmodel.ShowMapViewModel
import com.siasun.dianshi.utils.World
import com.siasun.dianshi.view.HomeDockView
import com.siasun.dianshi.view.MapView
import com.siasun.dianshi.view.MixAreaView
import com.siasun.dianshi.view.PolygonEditView
import com.siasun.dianshi.view.PostingAreasView
import com.siasun.dianshi.view.SpPolygonEditView
import com.siasun.dianshi.view.VirtualWallView
import com.siasun.dianshi.xpop.XpopUtils
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import kotlinx.coroutines.withContext
import org.jetbrains.anko.toast
import java.io.File
import kotlin.random.Random

/**
 * 显示地图
 */
class ShowMapViewActivity : BaseMvvmActivity<ActivityShowMapViewBinding, ShowMapViewModel>() {
    private var upRCData: laser_t = laser_t()

    val mapId = 2
    var cleanAreas: MutableList<CleanAreaNew> = mutableListOf()
    var mSpArea: MutableList<SpArea> = mutableListOf()
    var mMixArea: MutableList<WorkAreasNew> = mutableListOf()
    var cmsStation: MutableList<CmsStation> = mutableListOf()

    // 创建World对象并读取文件
    val world = World()

    @RequiresApi(Build.VERSION_CODES.R)
    override fun initView(savedInstanceState: Bundle?) {
        MainController.init()

        //点击屏幕回调
        mBinding.mapView.setSingleTapListener(object : MapView.ISingleTapListener {
            override fun onSingleTapListener(point: PointF) {
                LogUtil.i("点击屏幕回调  ${point}")
                //上激光
                upRCData.ranges[0] = point.x
                upRCData.ranges[1] = point.y

                LogUtil.i("点击屏幕回调x  ${upRCData.ranges[0]}")
                LogUtil.i("点击屏幕回调y ${upRCData.ranges[1]}")
                LogUtil.i("点击屏幕回调t ${upRCData.ranges[2]}")

                mBinding.mapView.setUpLaserScan(upRCData)

            }
        })

//        mBinding.btnAddTeachPath.onClick {
////            val json2 ="{\"dparams\":[],\"fparams\":[],\"iparams\":[],\"lparams\":[],\"m_cPathTypeBuffer\":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],\"m_fCleanPathPlanStartPosBuffer\":[5.286,-0.009,3.1620728E35],\"m_fElementBuffer\":[8.376,5.269,9.052838,5.276127,9.735463,5.2419443,10.411838,5.279603,10.411838,5.279603,11.088211,5.317261,11.764164,5.343837,12.4395485,5.339864,12.4395485,5.339864,13.114933,5.3358903,13.787697,5.330263,14.461338,5.339382,14.461338,5.339382,15.134979,5.348501,15.809291,5.366262,16.481258,5.3805075,16.481258,5.3805075,17.153227,5.3947535,17.818878,5.3949447,18.491167,5.405807,18.491167,5.405807,19.163456,5.41667,19.841251,5.4500256,20.514572,5.4430795,20.514572,5.4430795,21.187893,5.436134,21.859995,5.450444,22.53188,5.478367,22.53188,5.478367,23.203764,5.50629,23.874968,5.52005,24.54712,5.5205603,24.54712,5.5205603,25.219269,5.5210705,25.896204,5.5235777,26.566658,5.5316567,26.566658,5.5316567,27.23711,5.5397353,27.900465,5.5099506,28.569067,5.535492,28.569067,5.535492,29.23767,5.5610332,29.90712,5.573303,30.576048,5.5988555,30.576048,5.5988555,31.244978,5.624408,31.92055,5.6250944,32.58731,5.6274443,32.58731,5.6274443,33.254074,5.629794,33.932755,5.6713533,34.590187,5.7026925,34.590187,5.7026925,35.247623,5.7340317,35.97141,5.725162,36.60018,5.712918,36.60018,5.712918,37.22895,5.7006736,38.060036,5.80508,38.579395,5.697625,38.579395,5.697625,39.09876,5.590171,40.298515,4.9978185,40.135834,5.7645416,40.135834,5.7645416,39.973152,6.5312643,38.8615,6.000282,38.28926,6.0468855,38.28926,6.0468855,37.71702,6.0934896,36.933033,5.9447503,36.288216,6.0254703,36.288216,6.0254703,35.643402,6.1061897,34.932304,6.1068234,34.268562,6.1110964,34.268562,6.1110964,33.60482,6.115369,32.935272,6.070629,32.266857,6.0729227,32.266857,6.0729227,31.598442,6.075217,30.922983,6.023684,30.251406,6.0120735,30.251406,6.0120735,29.57983,6.000463,28.901402,5.9902906,28.230501,5.9949327,28.230501,5.9949327,27.559603,5.9995747,26.8966,5.9766574,26.227045,5.956712,26.227045,5.956712,25.557487,5.936766,24.887749,5.9238753,24.216196,5.9126396,24.216196,5.9126396,23.544641,5.9014034,22.86917,5.9206457,22.196436,5.9072685,22.196436,5.9072685,21.5237,5.8938913,20.853062,5.8676333,20.180191,5.836571,20.180191,5.836571,19.50732,5.8055086,18.831089,5.8047986,18.156143,5.8069053,18.156143,5.8069053,17.4812,5.8090115,16.797672,5.795639,16.125566,5.7655244,16.125566,5.7655244,15.45346,5.7354097,14.779823,5.747781,14.112914,5.748028,14.112914,5.748028,13.446005,5.748275,12.761993,5.762222,12.10686,5.721673,12.10686,5.721673,11.451726,5.6811237,10.729786,5.7729936,10.111622,5.6605406,10.111622,5.6605406,9.493459,5.548088,8.590731,6.1170473,8.256349,5.34853,8.256349,5.34853,7.921966,4.5800123,9.137574,4.603643,9.712716,4.739748,9.712716,4.739748,10.287858,4.875853,11.058854,4.736226,11.70582,4.780468,11.70582,4.780468,12.352785,4.8247104,13.063596,4.822666,13.730262,4.8259797,13.730262,4.8259797,14.396928,4.829293,15.074096,4.878851,15.742485,4.884395,15.742485,4.884395,16.410873,4.8899393,17.075933,4.86804,17.74618,4.8900313,17.74618,4.8900313,18.416426,4.9120226,19.09241,4.9338465,19.765797,4.935681,19.765797,4.935681,20.439186,4.937515,21.122297,4.9309053,21.793554,4.9674473,21.793554,4.9674473,22.464813,5.003989,23.128086,4.9752026,23.797413,5.0012817,23.797413,5.0012817,24.466742,5.0273604,25.133162,5.009925,25.8043,5.040123,25.8043,5.040123,26.475441,5.070321,27.153925,5.0701838,27.826101,5.068209,27.826101,5.068209,28.498278,5.0662346,29.158777,5.0819592,29.831415,5.106915,29.831415,5.106915,30.504053,5.1318707,31.153864,5.1297526,31.838196,5.131048,31.838196,5.131048,32.522526,5.1323442,33.143555,5.185711,33.866016,5.186148,33.866016,5.186148,34.588478,5.186585,35.04707,5.2434597,35.955185,5.2176957,35.955185,5.2176957,36.8633,5.1919312,38.310753,5.312164,39.338,5.286],\"m_fGloalPathPlanGoalPosBuffer\":[1.3759809E-38,0.0,0.0],\"m_fGloalPathPlanStartPosBuffer\":[0.4,1.5755796E-38,0.0],\"m_fRegionPointsBuffer\":[],\"m_iAddLaser\":0,\"m_iCleanPathPanType\":0,\"m_iElementSum\":376,\"m_iGloalPathPlanType\":0,\"m_iPathPlanPublicId\":11,\"m_iPathPlanPublicSubId\":0,\"m_iPathPlanRegionChoose\":54,\"m_iPathPlanType\":3,\"m_iPathSum\":47,\"m_iPlanResult\":1,\"m_iPlanResultMode\":0,\"m_iRegionNumber\":1109219869,\"m_iRegionPoints\":0,\"m_strAdditionInfo\":\"1.0.1.193\",\"m_strFrom\":\"PathPlan\",\"m_strTo\":\"pad\",\"m_uLayerNumber\":12846,\"ndparams\":0,\"nfparams\":0,\"niparams\":0,\"nlparams\":0,\"sparams\":\"\",\"utime\":0}"
////            val json2="{\"dparams\":[],\"fparams\":[],\"iparams\":[],\"lparams\":[],\"m_cPathTypeBuffer\":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],\"m_fCleanPathPlanStartPosBuffer\":[34.448,-0.197,3.1620728E35],\"m_fElementBuffer\":[-31.955,34.43,-31.278906,34.422024,-30.594679,34.469955,-29.919924,34.45202,-29.919924,34.45202,-29.245169,34.434086,-28.579124,34.471844,-27.906832,34.47458,-27.906832,34.47458,-27.234537,34.47731,-26.564053,34.53683,-25.891386,34.52824,-25.891386,34.52824,-25.218718,34.519653,-24.550268,34.5301,-23.87606,34.53009,-23.87606,34.53009,-23.20185,34.53008,-22.516884,34.5698,-21.84334,34.549236,-21.84334,34.549236,-21.169796,34.52867,-20.50532,34.558456,-19.834003,34.586823,-19.834003,34.586823,-19.162685,34.61519,-18.489586,34.63785,-17.816969,34.64818,-17.816969,34.64818,-17.144354,34.658504,-16.4721,34.652386,-15.799479,34.668816,-15.799479,34.668816,-15.126858,34.685246,-14.456918,34.68993,-13.7825985,34.69998,-13.7825985,34.69998,-13.108279,34.710033,-12.426639,34.723377,-11.751746,34.727657,-11.751746,34.727657,-11.076855,34.731934,-10.404874,34.740055,-9.730667,34.749786,-9.730667,34.749786,-9.05646,34.759518,-8.380449,34.74591,-7.706836,34.763878,-7.706836,34.763878,-7.0332227,34.78185,-6.363293,34.769028,-5.689811,34.802906,-5.689811,34.802906,-5.016329,34.83679,-4.339955,34.835125,-3.6656747,34.84416,-3.6656747,34.84416,-2.9913948,34.85319,-2.3276303,34.870556,-1.6499879,34.87496,-1.6499879,34.87496,-0.9723454,34.879368,-0.31316784,34.92984,0.37607393,34.90072,0.37607393,34.90072,1.0653157,34.871597,1.6856124,34.861023,2.2258222,34.2428,2.2258222,34.2428,2.7660317,33.624577,3.7847478,34.649666,3.0058618,34.967983,3.0058618,34.967983,2.2269757,35.286297,1.6734341,35.00544,0.9723597,35.07043,0.9723597,35.07043,0.27128538,35.13542,-0.36130044,35.066784,-1.0438424,35.048676,-1.0438424,35.048676,-1.7263844,35.030567,-2.4047701,35.02564,-3.0844827,35.00956,-3.0844827,35.00956,-3.764195,34.99348,-4.443157,35.02492,-5.117815,35.028057,-5.117815,35.028057,-5.792473,35.031193,-6.454396,34.97311,-7.1252875,34.9599,-7.1252875,34.9599,-7.79618,34.946686,-8.466016,34.959904,-9.137725,34.9542,-9.137725,34.9542,-9.809433,34.948498,-10.480868,34.931263,-11.154192,34.93813,-11.154192,34.93813,-11.827517,34.945,-12.505061,34.907715,-13.17865,34.915314,-13.17865,34.915314,-13.852239,34.922913,-14.5198145,34.87682,-15.193791,34.876007,-15.193791,34.876007,-15.867768,34.87519,-16.544344,34.855637,-17.220964,34.856747,-17.220964,34.856747,-17.897585,34.857853,-18.581085,34.82262,-19.257235,34.828075,-19.257235,34.828075,-19.933386,34.83353,-20.607124,34.809807,-21.27903,34.78637,-21.27903,34.78637,-21.950933,34.762928,-22.611887,34.78522,-23.284668,34.773224,-23.284668,34.773224,-23.957449,34.761227,-24.637884,34.724945,-25.311426,34.718132,-25.311426,34.718132,-25.984966,34.71132,-26.647076,34.676773,-27.321198,34.684643,-27.321198,34.684643,-27.995317,34.692516,-28.636858,34.55458,-29.325064,34.621063,-29.325064,34.621063,-30.01327,34.687546,-30.65203,34.476112,-31.30561,34.9859,-31.30561,34.9859,-31.95919,35.49569,-32.748844,34.257347,-31.96413,34.072998,-31.96413,34.072998,-31.179417,33.88865,-30.675285,34.381954,-29.964571,34.336952,-29.964571,34.336952,-29.253859,34.29195,-28.624887,34.3091,-27.942507,34.283,-27.942507,34.283,-27.260124,34.2569,-26.60173,34.316383,-25.924212,34.30835,-25.924212,34.30835,-25.246693,34.300312,-24.56632,34.324364,-23.890491,34.34698,-23.890491,34.34698,-23.214663,34.369595,-22.538067,34.334644,-21.86569,34.356773,-21.86569,34.356773,-21.193314,34.378902,-20.527546,34.331802,-19.857868,34.337166,-19.857868,34.337166,-19.18819,34.34253,-18.527325,34.384922,-17.85504,34.378315,-17.85504,34.378315,-17.182755,34.371704,-16.497553,34.383648,-15.82424,34.407253,-15.82424,34.407253,-15.150927,34.430862,-14.480206,34.412914,-13.809354,34.401257,-13.809354,34.401257,-13.138502,34.389595,-12.472526,34.4242,-11.802472,34.4292,-11.802472,34.4292,-11.13242,34.4342,-10.465532,34.433132,-9.793649,34.429813,-9.793649,34.429813,-9.121766,34.4265,-8.442716,34.437645,-7.7707143,34.46152,-7.7707143,34.46152,-7.0987134,34.4854,-6.435213,34.469173,-5.7623386,34.45935,-5.7623386,34.45935,-5.089464,34.44953,-4.410416,34.486755,-3.7360988,34.48007,-3.7360988,34.48007,-3.0617812,34.47338,-2.4005065,34.527573,-1.7231878,34.5001,-1.7231878,34.5001,-1.045869,34.472626,-0.42437974,34.801918,0.25163072,34.782784,0.25163072,34.782784,0.9276412,34.76365,1.5979455,34.60556,2.254,34.448],\"m_fGloalPathPlanGoalPosBuffer\":[1.3759809E-38,0.0,0.0],\"m_fGloalPathPlanStartPosBuffer\":[0.4,1.5755796E-38,0.0],\"m_fRegionPointsBuffer\":[],\"m_iAddLaser\":0,\"m_iCleanPathPanType\":0,\"m_iElementSum\":424,\"m_iGloalPathPlanType\":0,\"m_iPathPlanPublicId\":19,\"m_iPathPlanPublicSubId\":0,\"m_iPathPlanRegionChoose\":52,\"m_iPathPlanType\":3,\"m_iPathSum\":53,\"m_iPlanResult\":1,\"m_iPlanResultMode\":0,\"m_iRegionNumber\":1074807177,\"m_iRegionPoints\":0,\"m_strAdditionInfo\":\"1.0.1.193\",\"m_strFrom\":\"PathPlan\",\"m_strTo\":\"pad\",\"m_uLayerNumber\":13100,\"ndparams\":0,\"nfparams\":0,\"niparams\":0,\"nlparams\":0,\"sparams\":\"\",\"utime\":0}"
////            val json2 =
////                "{\"dparams\":[],\"fparams\":[],\"iparams\":[],\"lparams\":[],\"m_cPathTypeBuffer\":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],\"m_fCleanPathPlanStartPosBuffer\":[4.932,-3.086,3.1620728E35],\"m_fElementBuffer\":[3.061,5.024,2.3888915,4.961194,1.7159426,5.023054,1.0431048,5.0149074,1.0431048,5.0149074,0.37026703,5.0067606,-0.30168024,5.0053897,-0.97542024,5.0153337,-0.97542024,5.0153337,-1.6491601,5.0252776,-2.3227117,5.0001917,-2.9971504,4.968141,-2.9971504,4.968141,-3.6715891,4.9360905,-4.352805,4.924895,-5.0278225,4.9152493,-5.0278225,4.9152493,-5.7028394,4.9056034,-6.3783746,4.8855247,-7.050914,4.8878307,-7.050914,4.8878307,-7.7234526,4.8901362,-8.3909445,4.8872094,-9.061593,4.8784046,-9.061593,4.8784046,-9.732241,4.8696,-10.400481,4.863476,-11.071627,4.8593397,-11.071627,4.8593397,-11.742771,4.855204,-12.415219,4.8438096,-13.087057,4.833757,-13.087057,4.833757,-13.758894,4.823704,-14.429939,4.808732,-15.102149,4.791068,-15.102149,4.791068,-15.774359,4.7734036,-16.446943,4.8367004,-17.119505,4.8314724,-17.119505,4.8314724,-17.792067,4.826245,-18.466825,4.838149,-19.138414,4.834036,-19.138414,4.834036,-19.810003,4.8299227,-20.478046,4.7906666,-21.148367,4.7935557,-21.148367,4.7935557,-21.818687,4.7964444,-22.48187,4.7828946,-23.153883,4.779842,-23.153883,4.779842,-23.825893,4.7767887,-24.490889,4.7283583,-25.168703,4.72387,-25.168703,4.72387,-25.846518,4.7193813,-26.506424,4.768209,-27.198566,4.699258,-27.198566,4.699258,-27.890707,4.6303067,-28.492855,4.713727,-29.239105,4.6360936,-29.239105,4.6360936,-29.985355,4.55846,-30.368795,4.9899616,-31.165962,5.190134,-31.165962,5.190134,-31.963129,5.3903065,-31.891045,3.9694657,-31.061657,4.144218,-31.061657,4.144218,-30.23227,4.3189707,-29.744745,4.25559,-29.030996,4.3325386,-29.030996,4.3325386,-28.317247,4.4094877,-27.705038,4.4874845,-27.019659,4.432074,-27.019659,4.432074,-26.334282,4.376664,-25.661577,4.508123,-24.987015,4.436946,-24.987015,4.436946,-24.31245,4.3657684,-23.64473,4.286292,-22.9713,4.3328614,-22.9713,4.3328614,-22.297869,4.379431,-21.629211,4.3833504,-20.95336,4.3853636,-20.95336,4.3853636,-20.277506,4.387377,-19.591509,4.4141073,-18.915625,4.41571,-18.915625,4.41571,-18.23974,4.417313,-17.565552,4.4227805,-16.893059,4.4288673,-16.893059,4.4288673,-16.220568,4.4349546,-15.55619,4.4022803,-14.883937,4.4386373,-14.883937,4.4386373,-14.211684,4.474994,-13.531978,4.458403,-12.859028,4.476519,-12.859028,4.476519,-12.186078,4.4946356,-11.5143585,4.4805393,-10.84364,4.517814,-10.84364,4.517814,-10.172922,4.5550885,-9.502934,4.5414767,-8.832484,4.532224,-8.832484,4.532224,-8.162034,4.5229716,-7.49472,4.505003,-6.8228927,4.5373864,-6.8228927,4.5373864,-6.151065,4.56977,-5.4730973,4.578138,-4.8003697,4.595922,-4.8003697,4.595922,-4.1276426,4.6137066,-3.4700813,4.584989,-2.7940085,4.5882792,-2.7940085,4.5882792,-2.1179357,4.591569,-1.4540462,4.557092,-0.76774156,4.6320047,-0.76774156,4.6320047,-0.08143692,4.706917,0.52353597,4.5817447,1.2503622,4.723068,1.2503622,4.723068,1.9771882,4.8643913,2.4240942,4.2893143,3.2294037,4.3843417,3.2294037,4.3843417,4.0347133,4.4793696,3.5308383,5.724605,2.7678976,5.4471507,2.7678976,5.4471507,2.0049567,5.1696963,1.4451262,5.3508215,0.7441529,5.3358274,0.7441529,5.3358274,0.043179583,5.3208337,-0.6080825,5.2836165,-1.2876544,5.282159,-1.2876544,5.282159,-1.9672263,5.280701,-2.6232042,5.2592397,-3.2966523,5.2436275,-3.2966523,5.2436275,-3.9701004,5.2280154,-4.6320305,5.2135367,-5.3082223,5.245812,-5.3082223,5.245812,-5.9844136,5.2780876,-6.640281,5.222608,-7.329448,5.2155514,-7.329448,5.2155514,-8.018616,5.2084947,-8.645582,5.21893,-9.373067,5.185528,-9.373067,5.185528,-10.100552,5.152126,-10.51679,5.0933723,-11.445688,5.068314,-11.445688,5.068314,-12.374585,5.043256,-13.876556,5.2048035,-14.943,5.143,-14.943,5.143,-15.6154375,5.149388,-16.288586,5.1368327,-16.960695,5.137517,-16.960695,5.137517,-17.632807,5.138201,-18.305166,5.143348,-18.97619,5.1166334,-18.97619,5.1166334,-19.647215,5.089918,-20.306568,5.108411,-20.980324,5.102869,-20.980324,5.102869,-21.65408,5.097327,-22.303577,5.075698,-22.990284,5.0785985,-22.990284,5.0785985,-23.676992,5.0814986,-24.279696,5.0174084,-25.013683,5.044823,-25.013683,5.044823,-25.747673,5.072238,-26.125357,5.0601854,-27.10099,5.0002427,-27.10099,5.0002427,-28.076626,4.9403005,-29.76831,5.086801,-30.903,4.932],\"m_fGloalPathPlanGoalPosBuffer\":[1.3759809E-38,0.0,0.0],\"m_fGloalPathPlanStartPosBuffer\":[0.4,1.5755796E-38,0.0],\"m_fRegionPointsBuffer\":[],\"m_iAddLaser\":0,\"m_iCleanPathPanType\":0,\"m_iElementSum\":408,\"m_iGloalPathPlanType\":0,\"m_iPathPlanPublicId\":26,\"m_iPathPlanPublicSubId\":0,\"m_iPathPlanRegionChoose\":46,\"m_iPathPlanType\":3,\"m_iPathSum\":51,\"m_iPlanResult\":1,\"m_iPlanResultMode\":0,\"m_iRegionNumber\":-1040762536,\"m_iRegionPoints\":0,\"m_strAdditionInfo\":\"1.0.1.193\",\"m_strFrom\":\"PathPlan\",\"m_strTo\":\"pad\",\"m_uLayerNumber\":13612,\"ndparams\":0,\"nfparams\":0,\"niparams\":0,\"nlparams\":0,\"sparams\":\"\",\"utime\":0}"
//
//            val json2 ="{\"dparams\":[],\"fparams\":[],\"iparams\":[],\"lparams\":[],\"m_cPathTypeBuffer\":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],\"m_fCleanPathPlanStartPosBuffer\":[5.221,-0.285,3.43618412E17],\"m_fElementBuffer\":[8.288,5.256,8.958152,5.2684393,9.630912,5.2460303,10.300257,5.256089,10.300257,5.256089,10.969602,5.2661476,11.631265,5.3273163,12.301668,5.324317,12.301668,5.324317,12.972071,5.321318,13.645665,5.3141637,14.31843,5.322229,14.31843,5.322229,14.991195,5.3302946,15.670952,5.3473577,16.341887,5.3746953,16.341887,5.3746953,17.012823,5.402033,17.674097,5.4239974,18.345253,5.4292383,18.345253,5.4292383,19.016409,5.4344788,19.69387,5.4362497,20.366247,5.456277,20.366247,5.456277,21.038624,5.4763045,21.710434,5.4766097,22.38279,5.4920917,22.38279,5.4920917,23.055143,5.507573,23.731878,5.554006,24.402765,5.540463,24.402765,5.540463,25.073652,5.52692,25.73901,5.5119042,26.408121,5.531742,26.408121,5.531742,27.07723,5.55158,27.74627,5.528922,28.41504,5.5642014,28.41504,5.5642014,29.083807,5.599481,29.751934,5.6177506,30.422602,5.6313605,30.422602,5.6313605,31.093267,5.6449704,31.764828,5.6306477,32.436806,5.669992,32.436806,5.669992,33.10878,5.709336,33.79191,5.709876,34.463776,5.726282,34.463776,5.726282,35.13564,5.742688,35.804653,5.71322,36.473248,5.750372,36.473248,5.750372,37.141838,5.787524,37.824104,5.7841377,38.485073,5.7585816,38.485073,5.7585816,39.146046,5.733025,39.621006,4.691994,40.306015,5.206813,40.306015,5.206813,40.991024,5.721631,39.986195,6.375893,39.339333,6.1860785,39.339333,6.1860785,38.692474,5.996264,37.997154,6.130045,37.32821,6.105539,37.32821,6.105539,36.659267,6.081033,35.975986,6.1026525,35.305157,6.100126,35.305157,6.100126,34.63433,6.0975986,33.972553,6.073936,33.301422,6.0625124,33.301422,6.0625124,32.63029,6.0510883,31.953718,6.0521464,31.279987,6.0263305,31.279987,6.0263305,30.606256,6.000514,29.92763,5.997251,29.252966,5.9941344,29.252966,5.9941344,28.578304,5.991018,27.9049,5.9555254,27.230932,5.9601197,27.230932,5.9601197,26.556965,5.9647136,25.882263,5.9416437,25.208643,5.9256406,25.208643,5.9256406,24.53502,5.9096375,23.85965,5.9096003,23.186716,5.908752,23.186716,5.908752,22.513783,5.9079037,21.843386,5.904971,21.171928,5.8778734,21.171928,5.8778734,20.500473,5.8507752,19.830256,5.8999057,19.15867,5.8581686,19.15867,5.8581686,18.487085,5.8164315,17.811483,5.8351774,17.13985,5.8168507,17.13985,5.8168507,16.46822,5.7985234,15.806459,5.7548313,15.132723,5.7553005,15.132723,5.7553005,14.458986,5.7557697,13.787669,5.7380285,13.10924,5.7644725,13.10924,5.7644725,12.43081,5.7909164,11.798044,5.673964,11.102081,5.7074957,11.102081,5.7074957,10.406117,5.7410274,9.827753,5.5182157,9.065372,5.751179,9.065372,5.751179,8.302992,5.984143,7.8409743,4.7152348,8.690344,4.7146206,8.690344,4.7146206,9.539714,4.714007,10.021555,4.849305,10.74078,4.813417,10.74078,4.813417,11.460005,4.777529,12.088272,4.855582,12.771679,4.8505106,12.771679,4.8505106,13.455086,4.8454385,14.107589,4.861764,14.780472,4.8623366,14.780472,4.8623366,15.453355,4.862909,16.119036,4.851103,16.789219,4.8714433,16.789219,4.8714433,17.4594,4.8917837,18.123775,4.86957,18.794521,4.9143157,18.794521,4.9143157,19.465267,4.9590616,20.140661,4.927635,20.813293,4.9338717,20.813293,4.9338717,21.485928,4.940108,22.15319,4.978284,22.827143,4.9980316,22.827143,4.9980316,23.501097,5.017779,24.182444,5.023112,24.858768,5.029345,24.858768,5.029345,25.535095,5.0355783,26.21463,5.004602,26.890242,5.029114,26.890242,5.029114,27.565855,5.0536256,28.240461,5.101092,28.914116,5.1011953,28.914116,5.1011953,29.58777,5.101299,30.252031,5.099855,30.924337,5.137182,30.924337,5.137182,31.596643,5.1745095,32.26578,5.1738167,32.942444,5.1778803,32.942444,5.1778803,33.619102,5.181944,34.273315,5.223738,34.959496,5.2301354,34.959496,5.2301354,35.645676,5.236532,36.23581,5.304239,36.98409,5.333799,36.98409,5.333799,37.73237,5.3633585,38.69092,5.275811,39.481,5.221],\"m_fGloalPathPlanGoalPosBuffer\":[1.3759809E-38,0.0,0.0],\"m_fGloalPathPlanStartPosBuffer\":[0.4,1.5755796E-38,0.0],\"m_fRegionPointsBuffer\":[],\"m_iAddLaser\":0,\"m_iCleanPathPanType\":0,\"m_iElementSum\":384,\"m_iGloalPathPlanType\":0,\"m_iPathPlanPublicId\":10,\"m_iPathPlanPublicSubId\":0,\"m_iPathPlanRegionChoose\":53,\"m_iPathPlanType\":3,\"m_iPathSum\":48,\"m_iPlanResult\":1,\"m_iPlanResultMode\":0,\"m_iRegionNumber\":1109257355,\"m_iRegionPoints\":0,\"m_strAdditionInfo\":\"1.0.1.193\",\"m_strFrom\":\"PathPlan\",\"m_strTo\":\"pad\",\"m_uLayerNumber\":12846,\"ndparams\":0,\"nfparams\":0,\"niparams\":0,\"nlparams\":0,\"sparams\":\"\",\"utime\":0}"
//
//            val toBean1 = json2.toBean<PlanPathResult>()
//            val pathPlanResultBean = PathPlanningUtil1.getPathPlanResultBean(
//                toBean1
//            )
//            if (pathPlanResultBean.m_vecBezierOfPathPlan.isNotEmpty()) {
//                mBinding.mapView.setCleanPathPlanResultBean(
//                    PathPlanningUtil1.getPathPlanResultBean(toBean1, mBinding.mapView)
//                )
//            } else {
//                ToastUtils.showLong("保存试教失败")
//            }
//        }

        mBinding.btnAddTeachPath888.onClick {
//            val json3="{\"dparams\":[],\"fparams\":[],\"iparams\":[],\"lparams\":[],\"m_cPathTypeBuffer\":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],\"m_fCleanPathPlanStartPosBuffer\":[15.683,-3.115,3.43618412E17],\"m_fElementBuffer\":[39.721333,15.8,39.04981,15.777804,38.374836,15.711217,37.703693,15.7055645,37.703693,15.7055645,37.03255,15.699911,36.36795,15.652758,35.69729,15.660104,35.69729,15.660104,35.026627,15.667449,34.35931,15.644395,33.68634,15.643832,33.68634,15.643832,33.013374,15.64327,32.331932,15.633541,31.658041,15.615267,31.658041,15.615267,30.984148,15.5969925,30.314318,15.5918045,29.64044,15.583754,29.64044,15.583754,28.966562,15.575703,28.290234,15.55923,27.616777,15.524065,27.616777,15.524065,26.943323,15.4889,26.27167,15.44839,25.596718,15.475716,25.596718,15.475716,24.921764,15.503041,24.242765,15.509002,23.566954,15.503495,23.566954,15.503495,22.891144,15.497988,22.21086,15.475346,21.538233,15.45624,21.538233,15.45624,20.865606,15.437133,20.200048,15.417529,19.530483,15.40477,19.530483,15.40477,18.860918,15.39201,18.197222,15.384541,17.526636,15.371365,17.526636,15.371365,16.85605,15.358188,16.176405,15.3674135,15.504976,15.352888,15.504976,15.352888,14.833548,15.338363,14.14159,15.283519,13.478365,15.272807,13.478365,15.272807,12.815141,15.262095,12.108112,15.199871,11.473271,15.216878,11.473271,15.216878,10.838431,15.233886,10.014508,15.08311,9.49446,15.324536,9.49446,15.324536,8.974412,15.565962,7.706413,15.804664,7.9560537,15.076769,7.9560537,15.076769,8.205694,14.348875,9.2460165,14.847717,9.833997,14.814517,9.833997,14.814517,10.421978,14.781318,11.176502,14.912625,11.828522,14.8818035,11.828522,14.8818035,12.480542,14.850981,13.178333,14.897853,13.846094,14.887654,13.846094,14.887654,14.513854,14.877456,15.19219,14.951988,15.864042,14.961325,15.864042,14.961325,16.535894,14.970662,17.213882,14.991205,17.886375,14.979115,17.886375,14.979115,18.558868,14.967023,19.229092,15.006846,19.900959,15.027129,19.900959,15.027129,20.572828,15.047412,21.249964,15.05349,21.921492,15.049951,21.921492,15.049951,22.593018,15.046411,23.259125,15.116554,23.929247,15.1157255,23.929247,15.1157255,24.599367,15.114896,25.266645,15.1319475,25.936481,15.151996,25.936481,15.151996,26.606318,15.172043,27.277252,15.200761,27.947973,15.19894,27.947973,15.19894,28.618692,15.197119,29.28871,15.225064,29.959688,15.22956,29.959688,15.22956,30.630669,15.234055,31.30367,15.217395,31.9738,15.260744,31.9738,15.260744,32.643932,15.304093,33.307415,15.218848,33.980423,15.259467,33.980423,15.259467,34.653427,15.300086,35.32185,15.29762,36.002396,15.3304205,36.002396,15.3304205,36.68294,15.363221,37.338768,15.290271,38.037964,15.399033,38.037964,15.399033,38.737156,15.507793,39.250114,14.63163,39.967865,15.0338335,39.967865,15.0338335,40.68561,15.436037,39.862907,16.376585,39.177155,16.115719,39.177155,16.115719,38.4914,15.854854,37.835323,16.031933,37.15928,16.048811,37.15928,16.048811,36.48323,16.065691,35.819504,16.071468,35.147125,16.061018,35.147125,16.061018,34.474743,16.050566,33.807068,16.043352,33.135254,16.03915,33.135254,16.03915,32.463436,16.034946,31.78731,16.054602,31.116398,16.028383,31.116398,16.028383,30.445486,16.002165,29.77593,16.020523,29.106627,16.00705,29.106627,16.00705,28.437325,15.993576,27.771326,16.019531,27.103144,16.014261,27.103144,16.014261,26.434961,16.008993,25.772673,15.943722,25.103209,15.95639,25.103209,15.95639,24.433744,15.96906,23.75869,15.932035,23.089613,15.903627,23.089613,15.903627,22.420534,15.87522,21.75599,15.910895,21.088,15.912212,21.088,15.912212,20.42001,15.91353,19.75589,15.899944,19.086098,15.887609,19.086098,15.887609,18.416307,15.875273,17.741932,15.822024,17.0698,15.8294115,17.0698,15.8294115,16.397667,15.836798,15.733293,15.822312,15.058986,15.812802,15.058986,15.812802,14.384679,15.803293,13.740151,15.789309,13.051661,15.788449,13.051661,15.788449,12.36317,15.787589,11.750727,15.775416,10.99712,15.762945,10.99712,15.762945,10.243512,15.750473,9.28469,15.693305,8.485,15.683],\"m_fGloalPathPlanGoalPosBuffer\":[1.3759809E-38,0.0,0.0],\"m_fGloalPathPlanStartPosBuffer\":[0.4,1.5755796E-38,0.0],\"m_fRegionPointsBuffer\":[],\"m_iAddLaser\":0,\"m_iCleanPathPanType\":0,\"m_iElementSum\":384,\"m_iGloalPathPlanType\":0,\"m_iPathPlanPublicId\":13,\"m_iPathPlanPublicSubId\":0,\"m_iPathPlanRegionChoose\":53,\"m_iPathPlanType\":3,\"m_iPathSum\":48,\"m_iPlanResult\":1,\"m_iPlanResultMode\":0,\"m_iRegionNumber\":1091027599,\"m_iRegionPoints\":0,\"m_strAdditionInfo\":\"1.0.1.193\",\"m_strFrom\":\"PathPlan\",\"m_strTo\":\"pad\",\"m_uLayerNumber\":12588,\"ndparams\":0,\"nfparams\":0,\"niparams\":0,\"nlparams\":0,\"sparams\":\"\",\"utime\":0}"
            val json4 =
                "{\"dparams\":[],\"fparams\":[],\"iparams\":[],\"lparams\":[],\"m_cPathTypeBuffer\":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],\"m_fCleanPathPlanStartPosBuffer\":[25.862,-3.117,3.1620728E35],\"m_fElementBuffer\":[40.062,25.804,39.387703,25.810602,38.716415,25.751215,38.04105,25.746592,38.04105,25.746592,37.365685,25.74197,36.689564,25.720613,36.01306,25.712933,36.01306,25.712933,35.33656,25.705252,34.655544,25.702478,33.979397,25.689482,33.979397,25.689482,33.30325,25.676487,32.62538,25.679302,31.951876,25.663973,31.951876,25.663973,31.278372,25.648643,30.614199,25.628904,29.941591,25.63131,29.941591,25.63131,29.268984,25.633715,28.597654,25.61176,27.922607,25.597229,27.922607,25.597229,27.247559,25.582699,26.566221,25.555826,25.890007,25.541916,25.890007,25.541916,25.21379,25.528004,24.540682,25.533407,23.864075,25.526226,23.864075,25.526226,23.18747,25.519045,22.502283,25.537409,21.827349,25.530523,21.827349,25.530523,21.152412,25.523638,20.487541,25.442387,19.814386,25.43702,19.814386,25.43702,19.141232,25.431652,18.465046,25.448082,17.793053,25.42156,17.793053,25.42156,17.121061,25.395037,16.452095,25.387903,15.781707,25.360962,15.781707,25.360962,15.111319,25.33402,14.448771,25.337297,13.775929,25.332735,13.775929,25.332735,13.103087,25.328173,12.432775,25.317726,11.754166,25.309414,11.754166,25.309414,11.075558,25.301102,10.426033,25.133507,9.724972,25.281557,9.724972,25.281557,9.02391,25.429605,8.535073,24.347897,7.8612576,24.80156,7.8612576,24.80156,7.187442,25.255222,8.161446,26.02088,8.813148,25.856398,8.813148,25.856398,9.464849,25.691914,10.160942,25.815859,10.832324,25.809998,10.832324,25.809998,11.503707,25.804134,12.176946,25.848244,12.857081,25.865353,12.857081,25.865353,13.537217,25.882462,14.182873,25.86833,14.882232,25.874533,14.882232,25.874533,15.581592,25.880735,16.128107,25.929327,16.899961,25.92127,16.899961,25.92127,17.671816,25.913212,17.937841,25.983894,18.978895,25.9451,18.978895,25.9451,20.019949,25.906307,21.204557,26.238676,19.18,25.602,19.18,25.602,19.73525,26.019388,20.448076,25.969776,21.115318,26.012808,21.115318,26.012808,21.78256,26.05584,22.474463,26.10246,23.146753,26.125605,23.146753,26.125605,23.819046,26.148748,24.48519,26.103867,25.15602,26.087572,25.15602,26.087572,25.82685,26.071278,26.500221,26.018898,27.168684,25.970318,27.168684,25.970318,27.837149,25.921738,28.497967,25.860212,29.166521,25.812199,29.166521,25.812199,29.835075,25.764185,30.510044,25.739374,31.179312,25.693724,31.179312,25.693724,31.84858,25.648071,32.5117,25.689852,33.182743,25.712933,33.182743,25.712933,33.85379,25.736012,34.52073,25.775736,35.198936,25.745604,35.198936,25.745604,35.877144,25.715471,36.53814,25.827837,37.240616,25.769354,37.240616,25.769354,37.943092,25.710869,38.98699,26.313087,39.393,25.819,39.393,25.819,39.558334,25.833334,39.723667,25.847666,39.889,25.862],\"m_fGloalPathPlanGoalPosBuffer\":[1.3759809E-38,0.0,0.0],\"m_fGloalPathPlanStartPosBuffer\":[0.4,1.5755796E-38,0.0],\"m_fRegionPointsBuffer\":[],\"m_iAddLaser\":0,\"m_iCleanPathPanType\":0,\"m_iElementSum\":272,\"m_iGloalPathPlanType\":0,\"m_iPathPlanPublicId\":4,\"m_iPathPlanPublicSubId\":0,\"m_iPathPlanRegionChoose\":46,\"m_iPathPlanType\":3,\"m_iPathSum\":34,\"m_iPlanResult\":1,\"m_iPlanResultMode\":0,\"m_iRegionNumber\":1109364310,\"m_iRegionPoints\":0,\"m_strAdditionInfo\":\"1.0.1.193\",\"m_strFrom\":\"PathPlan\",\"m_strTo\":\"pad\",\"m_uLayerNumber\":13618,\"ndparams\":0,\"nfparams\":0,\"niparams\":0,\"nlparams\":0,\"sparams\":\"\",\"utime\":0}"
            val json5 =
                "{\"dparams\":[],\"fparams\":[],\"iparams\":[],\"lparams\":[],\"m_cPathTypeBuffer\":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],\"m_fCleanPathPlanStartPosBuffer\":[24.825,-3.096,3.1620728E35],\"m_fElementBuffer\":[39.904,25.862333,39.236538,25.813992,38.571064,25.811943,37.901184,25.811747,37.901184,25.811747,37.231304,25.811552,36.55792,25.758274,35.887486,25.74727,35.887486,25.74727,35.217056,25.736265,34.549095,25.73786,33.878975,25.71846,33.878975,25.71846,33.20885,25.699059,32.534702,25.697628,31.865633,25.665777,31.865633,25.665777,31.196566,25.633926,30.533142,25.660868,29.86234,25.642149,29.86234,25.642149,29.191542,25.62343,28.50932,25.628143,27.838356,25.628967,27.838356,25.628967,27.167395,25.629793,26.506622,25.623482,25.836252,25.610641,25.836252,25.610641,25.165884,25.597801,24.489801,25.600819,23.818329,25.59774,23.818329,25.59774,23.146856,25.594664,22.479414,25.539263,21.808022,25.523426,21.808022,25.523426,21.13663,25.50759,20.460546,25.488852,19.789766,25.473562,19.789766,25.473562,19.118984,25.458275,18.45393,25.511044,17.783882,25.48073,17.783882,25.48073,17.113834,25.450415,16.439474,25.415682,15.768112,25.388884,15.768112,25.388884,15.09675,25.362085,14.417578,25.339277,13.748511,25.330856,13.748511,25.330856,13.079444,25.322435,12.408555,25.32908,11.747271,25.271276,11.747271,25.271276,11.085986,25.21347,10.387596,25.239616,9.744929,25.190437,9.744929,25.190437,9.102263,25.141258,8.4857645,24.1901,7.891653,24.851772,7.891653,24.851772,7.2975416,25.513445,8.349933,25.976414,8.9834585,25.859669,8.9834585,25.859669,9.616984,25.742922,10.330651,25.768108,10.993895,25.755903,10.993895,25.755903,11.657139,25.7437,12.32748,25.841076,12.994801,25.847013,12.994801,25.847013,13.662121,25.85295,14.330002,25.842897,14.999526,25.861525,14.999526,25.861525,15.669049,25.880154,16.34205,25.918203,17.014875,25.930832,17.014875,25.930832,17.687698,25.943462,18.364235,25.927807,19.038586,25.925137,19.038586,25.925137,19.712934,25.922466,20.388468,25.970095,21.063683,25.967657,21.063683,25.967657,21.738897,25.965221,22.41611,26.001621,23.090567,26.007391,23.090567,26.007391,23.765024,26.01316,24.441294,26.006721,25.112505,26.033777,25.112505,26.033777,25.783714,26.060831,26.443905,26.014008,27.114563,26.028484,27.114563,26.028484,27.785221,26.04296,28.456211,26.009645,29.129946,26.044598,29.129946,26.044598,29.80368,26.079548,30.480206,26.098366,31.15773,26.088495,31.15773,26.088495,31.835255,26.078625,32.51068,26.124659,33.192112,26.12884,33.192112,26.12884,33.873547,26.13302,34.54078,26.11557,35.23087,26.104263,35.23087,26.104263,35.920956,26.092955,36.554825,26.08199,37.272427,26.037868,37.272427,26.037868,37.990032,25.99375,38.508064,26.047205,39.223164,26.443409,39.223164,26.443409,39.938263,26.839613,40.435528,25.497486,39.584545,25.43407,39.584545,25.43407,38.733566,25.370657,38.247765,25.489344,37.529125,25.451601,37.529125,25.451601,36.810486,25.413858,36.20466,25.346724,35.52038,25.358265,35.52038,25.358265,34.836098,25.369806,34.174156,25.339708,33.497906,25.315048,33.497906,25.315048,32.821655,25.29039,32.151573,25.271238,31.47754,25.257513,31.47754,25.257513,30.803505,25.24379,30.131887,25.256529,29.458988,25.242989,29.458988,25.242989,28.78609,25.229446,28.118101,25.204939,27.444086,25.191,27.444086,25.191,26.770073,25.177061,26.089,25.136917,25.414835,25.129436,25.414835,25.129436,24.740667,25.121954,24.074514,25.075167,23.4009,25.070997,23.4009,25.070997,22.727285,25.06683,22.055286,25.019823,21.379658,25.012892,21.379658,25.012892,20.70403,25.005962,20.038412,25.00104,19.357279,24.991585,19.357279,24.991585,18.676146,24.98213,18.02717,24.98333,17.330086,24.953047,17.330086,24.953047,16.633001,24.922764,16.075932,24.92779,15.28514,24.91986,15.28514,24.91986,14.494349,24.91193,13.396252,24.905287,12.536,24.894,12.536,24.894,11.841026,24.819193,11.198787,24.823208,10.485987,24.817509,10.485987,24.817509,9.773187,24.811808,8.996069,24.850632,8.268,24.825],\"m_fGloalPathPlanGoalPosBuffer\":[1.3759809E-38,0.0,0.0],\"m_fGloalPathPlanStartPosBuffer\":[0.4,1.5755796E-38,0.0],\"m_fRegionPointsBuffer\":[],\"m_iAddLaser\":0,\"m_iCleanPathPanType\":0,\"m_iElementSum\":384,\"m_iGloalPathPlanType\":0,\"m_iPathPlanPublicId\":7,\"m_iPathPlanPublicSubId\":0,\"m_iPathPlanRegionChoose\":46,\"m_iPathPlanType\":3,\"m_iPathSum\":48,\"m_iPlanResult\":1,\"m_iPlanResultMode\":0,\"m_iRegionNumber\":1090800058,\"m_iRegionPoints\":0,\"m_strAdditionInfo\":\"1.0.1.193\",\"m_strFrom\":\"PathPlan\",\"m_strTo\":\"pad\",\"m_uLayerNumber\":13362,\"ndparams\":0,\"nfparams\":0,\"niparams\":0,\"nlparams\":0,\"sparams\":\"\",\"utime\":0}"
            val toBean1 = json5.toBean<PlanPathResult>()
            val pathPlanResultBean = PathPlanningUtil1.getPathPlanResultBean(
                toBean1
            )
            if (pathPlanResultBean.m_vecBezierOfPathPlan.isNotEmpty()) {
                mBinding.mapView.setCleanPathPlanResultBean(
                    PathPlanningUtil1.getPathPlanResultBean(toBean1, mBinding.mapView)
                )
            } else {
                ToastUtils.showLong("保存试教失败")
            }
        }

        //保存
        mBinding.btnSaveTeach.onClick {
            savePathsToFile()
            ToastUtils.showLong("保存试教")
        }


        //开始试教
        mBinding.btnStartTeach.onClick {
            MainController.sendStartTeachRoute()
            ToastUtils.showLong("开始试教")
        }
        //结束试教
        mBinding.btnEndTeach.onClick {
            MainController.sendSopTeachRoute()
            ToastUtils.showLong("结束试教")
        }

        //接收路径规划结果
        LiveEventBus.get<PlanPathResult>(KEY_UPDATE_PLAN_PATH_RESULT).observe(this) { result ->
            try {
                if (result.m_iPathPlanType == TEACH_PATH_PLAN) {
                    // 接收Pad申请的示教径规划结果
                    // 路段模式
                    if (result.m_iPlanResultMode == PATH_MODE) {
                        LogUtil.i(
                            "CustomPathActivity1接收示教路径规划", null, TAG_PP
                        )
                        mBinding.mapView.setCleanPathPlanResultBean(
                            PathPlanningUtil1.getPathPlanResultBean(result, mBinding.mapView)
                        )
                    }
                }
            } catch (e: Exception) {
                LogUtil.i("接收试教路径规划失败")
            }
        }

        //接收士教中的数据
        LiveEventBus.get<TeachPoint>(KEY_TEACH_PATH).observe(this) {
//            LogUtil.i("接收士教中的数据 $it", null, TAG_PP)
            mBinding.mapView.setTeachPoint(
                com.siasun.dianshi.bean.TeachPoint(
                    it.x, it.y, it.theta
                )
            )
        }


        //加载地图
        mBinding.mapView.loadMap(
            ConstantBase.getFilePath(mapId, ConstantBase.PAD_MAP_NAME_PNG),
            ConstantBase.getFilePath(mapId, ConstantBase.PAD_MAP_NAME_YAML)
        )
        //移动模式
        mBinding.btnMove.setOnClickListener {
            mBinding.mapView.setWorkMode(MapView.WorkMode.MODE_SHOW_MAP)
        }
//
//        initMergedPose()
//        initStation()
//        iniVirtualWall()
//        initRemoveNoise()
//        initPostingArea()
        initCleanArea()
//        initElevator()
//        initPose()
//        initMachineStation()
//        initMixArea()
//        initSpAreas()
//        initPath()
        initCrossDoor()

        mBinding.btnAddGloblePath.onClick {

            //全局
            val gloJson2 =
                "{\"dparams\":[],\"fparams\":[],\"iparams\":[0,0,0,0,0,0],\"lparams\":[250,250,250,250,250,250],\"m_cPathTypeBuffer\":[1,1,1,1,1,1],\"m_fCleanPathPlanStartPosBuffer\":[0.0,0.0,0.0],\"m_fElementBuffer\":[29.556,2.773,28.81566,2.2297862,28.331419,2.521509,28.374287,3.2572424,28.374287,3.2572424,28.417152,3.992976,28.285984,4.535049,28.325058,5.2433286,28.325058,5.2433286,28.364132,5.951608,28.317911,6.563604,28.332159,7.251959,28.332159,7.251959,28.346405,7.9403143,28.321201,8.552634,28.336176,9.260889,28.336176,9.260889,28.351149,9.969143,28.30004,10.470266,28.346638,11.310041,28.346638,11.310041,28.393236,12.1498165,28.121954,13.249701,27.914,14.092],\"m_fGloalPathPlanGoalPosBuffer\":[27.914,14.092,1.46],\"m_fGloalPathPlanStartPosBuffer\":[29.556,2.773,1.55],\"m_fRegionPointsBuffer\":[],\"m_iAddLaser\":0,\"m_iCleanPathPanType\":0,\"m_iElementSum\":48,\"m_iGloalPathPlanType\":1,\"m_iPathPlanPublicId\":65538,\"m_iPathPlanPublicSubId\":127,\"m_iPathPlanRegionChoose\":0,\"m_iPathPlanType\":1,\"m_iPathSum\":6,\"m_iPlanResult\":1,\"m_iPlanResultMode\":0,\"m_iRegionNumber\":0,\"m_iRegionPoints\":0,\"m_strAdditionInfo\":\"1.0.1.176-MultyLayers\",\"m_strFrom\":\"PathPlan\",\"m_strTo\":\"CMS\",\"m_uLayerNumber\":1,\"ndparams\":0,\"nfparams\":0,\"niparams\":6,\"nlparams\":6,\"sparams\":\"\",\"utime\":0}"

            val gloJson =
                " {\"dparams\":[],\"fparams\":[],\"iparams\":[],\"lparams\":[],\"m_cPathTypeBuffer\":[],\"m_fCleanPathPlanStartPosBuffer\":[0.0,0.0,0.0],\"m_fElementBuffer\":[],\"m_fGloalPathPlanGoalPosBuffer\":[49.193,7.008,-0.89],\"m_fGloalPathPlanStartPosBuffer\":[-0.078,0.007,0.05],\"m_fRegionPointsBuffer\":[],\"m_iAddLaser\":0,\"m_iCleanPathPanType\":0,\"m_iElementSum\":0,\"m_iGloalPathPlanType\":1,\"m_iPathPlanPublicId\":65538,\"m_iPathPlanPublicSubId\":127,\"m_iPathPlanRegionChoose\":0,\"m_iPathPlanType\":1,\"m_iPathSum\":0,\"m_iPlanResult\":8,\"m_iPlanResultMode\":0,\"m_iRegionNumber\":0,\"m_iRegionPoints\":0,\"m_strAdditionInfo\":\"1.0.1.176-MultyLayers\",\"m_strFrom\":\"PathPlan\",\"m_strTo\":\"CMS\",\"m_uLayerNumber\":2,\"ndparams\":0,\"nfparams\":0,\"niparams\":0,\"nlparams\":0,\"sparams\":\"\",\"utime\":0}"
            val toBean = gloJson2.toBean<PlanPathResult>()

            val pathPlanResultBean = PathPlanningUtil1.getPathPlanResultBean(
                toBean
            )
            LogUtil.d("pathPlanResultBean.m_vecLineOfPathPlan.size ${pathPlanResultBean.m_vecLineOfPathPlan.size}")
            LogUtil.d("pathPlanResultBean.m_vecBezierOfPathPlan.size ${pathPlanResultBean.m_vecBezierOfPathPlan.size}")

            LogUtil.i(
                "CleanAutoActivity接收全局路径规划 ${pathPlanResultBean.toJson()}", null, TAG_PP
            )

            if (pathPlanResultBean.m_vecBezierOfPathPlan.isNotEmpty()) {
                mBinding.mapView.setGlobalPathPlanResultBean(
                    pathPlanResultBean
                )
            } else {
                ToastUtils.showLong("全局路径规划失败")
            }
        }

        mBinding.btnAddCleanPath.onClick {
            val json =
                "{\"dparams\":[],\"fparams\":[],\"iparams\":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],\"lparams\":[251,251,251,251,251,251,251,251,255,255,255,255,255,255,255,255,255,255,255,255],\"m_cPathTypeBuffer\":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],\"m_fCleanPathPlanStartPosBuffer\":[29.555,2.786,1.55],\"m_fElementBuffer\":[27.914648,14.092113,27.932629,14.26437,27.950836,14.419361,27.968824,14.596,27.968824,14.596,27.986814,14.772638,28.010489,14.95114,28.026693,15.136461,28.026693,15.136461,28.042898,15.321781,28.07783,15.44616,28.06549,15.660672,28.06549,15.660672,28.053152,15.875183,28.275229,15.871054,28.41646,15.733574,28.41646,15.733574,28.557692,15.596093,28.528708,15.415093,28.495771,15.238,28.495771,15.238,28.462835,15.060905,28.455446,14.876434,28.433403,14.698689,28.433403,14.698689,28.411358,14.520945,28.396637,14.348806,28.375942,14.172338,28.375942,14.172338,28.385729,14.121772,28.395517,14.071205,28.405304,14.020639,28.405304,14.020639,28.238195,13.970711,28.071644,13.983357,27.907492,13.912709,27.907492,13.912709,27.74334,13.842061,27.491655,13.862228,27.536877,14.076725,27.536877,14.076725,27.582098,14.291223,27.580418,14.412807,27.600128,14.598263,27.600128,14.598263,27.619839,14.783718,27.63125,14.970391,27.648703,15.14286,27.648703,15.14286,27.666155,15.3153305,27.678793,15.490119,27.693468,15.643509,27.693468,15.643509,27.708145,15.796899,27.656052,16.055065,27.837917,16.086344,27.837917,16.086344,28.019781,16.117622,28.16111,16.024391,28.341843,16.041842,28.341843,16.041842,28.522573,16.059292,28.698399,15.948868,28.70547,15.761645,28.70547,15.761645,28.712538,15.574423,28.787008,15.427553,28.816484,15.253507,28.816484,15.253507,28.84596,15.079459,28.912094,14.931723,28.933083,14.754136,28.933083,14.754136,28.954071,14.5765505,29.066494,14.439697,29.058037,14.23402,29.058037,14.23402,29.04958,14.028343,28.55292,14.106234,28.405304,14.020639],\"m_fGloalPathPlanGoalPosBuffer\":[0.0,0.0,0.0],\"m_fGloalPathPlanStartPosBuffer\":[0.0,0.0,0.0],\"m_fRegionPointsBuffer\":[27.267136,16.693888,26.919456,13.138414,29.841938,13.705275,29.146591,16.533278],\"m_iAddLaser\":513894328,\"m_iCleanPathPanType\":3,\"m_iElementSum\":160,\"m_iGloalPathPlanType\":0,\"m_iPathPlanPublicId\":48469,\"m_iPathPlanPublicSubId\":0,\"m_iPathPlanRegionChoose\":2,\"m_iPathPlanType\":2,\"m_iPathSum\":20,\"m_iPlanResult\":1,\"m_iPlanResultMode\":0,\"m_iRegionNumber\":48469,\"m_iRegionPoints\":8,\"m_strAdditionInfo\":\"1.0.1.176-MultyLayers\",\"m_strFrom\":\"PathPlan\",\"m_strTo\":\"CMS\",\"m_uLayerNumber\":1,\"ndparams\":0,\"nfparams\":0,\"niparams\":20,\"nlparams\":20,\"sparams\":\"\",\"utime\":0}"
            val toBean1 = json.toBean<PlanPathResult>()
            val pathPlanResultBean = PathPlanningUtil1.getPathPlanResultBean(
                toBean1
            )
            if (pathPlanResultBean.m_vecBezierOfPathPlan.isNotEmpty()) {
                mBinding.mapView.setCleanPathPlanResultBean(
                    pathPlanResultBean
                )
            } else {
                ToastUtils.showLong("全局路径规划失败")
            }
        }
    }

    //过门
    fun initCrossDoor() {
        // 设置线点击事件监听器
        mBinding.mapView.mCrossView?.setOnCrossDoorLineClickListener(object :
            com.siasun.dianshi.view.CrossDoorView.OnCrossDoorLineClickListener {
            override fun onCrossDoorLineClick(crossDoor: com.siasun.dianshi.bean.CrossDoor) {
                // 点击了过门线，弹框显示信息
                showCrossDoorDialog(crossDoor)
            }
        })


        mBinding.btnAddCrossDoor.onClick {
            // 设置工作模式为添加过门模式
            mBinding.mapView.setWorkMode(MapView.WorkMode.MODE_CROSS_DOOR_ADD)
            // 在屏幕中心创建一个新的过门
            mBinding.mapView.mCrossView?.createCrossDoorAtCenter()

            val crossDoor = com.siasun.dianshi.bean.CrossDoor(
                id = 1,
                map_id = 2,
                door_msg = com.siasun.dianshi.bean.DoorMsg(
                    door_sn = "DOOR_001",
                    type = "cross_door"
                ),
            )
            mBinding.mapView.mCrossView?.addCrossDoor(crossDoor)
            ToastUtils.showLong("已进入添加过门模式")
        }

        // 设置线点击事件监听器
        mBinding.mapView.mCrossView?.setOnCrossDoorDeleteClickListener(object :
            com.siasun.dianshi.view.CrossDoorView.OnCrossDoorDeleteClickListener {
            override fun onCrossDoorDeleteClick(crossDoor: com.siasun.dianshi.bean.CrossDoor) {
                // 点击了过门线，弹框显示信息
                showCrossDoorDialog(crossDoor)
            }
        })
        mBinding.btnDeleteCrossDoor.onClick {
            // 切换到删除模式
            mBinding.mapView.setWorkMode(MapView.WorkMode.MODE_CROSS_DOOR_DELETE)
            ToastUtils.showLong("已进入删除过门模式，点击线段进行删除")
        }

        mBinding.btnEditCrossDoor.onClick {
            // 切换到编辑模式
            mBinding.mapView.setWorkMode(MapView.WorkMode.MODE_CROSS_DOOR_EDIT)
            ToastUtils.showLong("已进入编辑过门模式，可拖动端点修改位置")
        }

    }

    @RequiresApi(Build.VERSION_CODES.R)
    private fun initPath() {
        showLoading("加载中")
        // 地图加载完成后，加载路径数据
        readPathsFromFile()
        // 设置路径属性编辑回调监听器
        mBinding.mapView.setOnPathAttributeEditListener(object :
            com.siasun.dianshi.view.WorldPadView.OnPathAttributeEditListener {
            override fun onNodeSelected(
                node: com.siasun.dianshi.bean.pp.world.Node,
                path: com.siasun.dianshi.bean.pp.world.Path
            ) {
                // 处理选中节点事件
                Log.d(
                    "ShowMapViewActivity",
                    "选中节点: id=${node.m_uId}, x=${node.x}, y=${node.y}, 所属路段: ${path.GetStartNode()?.m_uId}->${path.GetEndNode()?.m_uId}"
                )
                toast("选中节点: id=${node.m_uId}, x=${node.x}, y=${node.y}, 所属路段: ${path.GetStartNode()?.m_uId}->${path.GetEndNode()?.m_uId}")
                mBinding.mapView.getLayer()?.updateNodeAttr(node)

                // 这里可以显示节点属性编辑界面，或者执行其他操作
            }

            override fun onPathSelected(path: com.siasun.dianshi.bean.pp.world.Path) {
                // 处理选中路段事件
                val startNode = path.GetStartNode()
                val endNode = path.GetEndNode()
                Log.d("ShowMapViewActivity", "选中路段: ${startNode?.m_uId}->${endNode?.m_uId}")
                toast("选中路段: ${startNode?.m_uId}->${endNode?.m_uId}")

                mBinding.mapView.getLayer()?.updatePathAttr(path)
            }

            override fun onPathDeleted(path: com.siasun.dianshi.bean.pp.world.Path) {
                // 处理删除路段事件
                // 直接使用Path对象中的节点ID属性，避免通过可能返回null的节点对象获取
                val startNodeId = path.m_uStartNode
                val endNodeId = path.m_uEndNode
                Log.d("ShowMapViewActivity", "删除路段: $startNodeId->$endNodeId")
                // 可以在这里添加删除路段后的业务逻辑
                onPathDataChanged()
            }

            override fun onNodeDeleted(node: com.siasun.dianshi.bean.pp.world.Node) {
                // 处理删除节点事件
                Log.d("ShowMapViewActivity", "删除节点: id=${node.m_uId}, x=${node.x}, y=${node.y}")
                // 可以在这里添加删除节点后的业务逻辑
                onPathDataChanged()
            }
        })

        // 编辑路线
        mBinding.btnEditPath.onClick {
            mBinding.mapView.setWorkMode(MapView.WorkMode.MODE_PATH_EDIT)
        }
        //路段属性编辑
        mBinding.btnEditPathArr.onClick {
            mBinding.mapView.setWorkMode(MapView.WorkMode.MODE_PATH_SEGMENT_ATTR_EDIT)

        }

        //节点属性编辑
        mBinding.btnEditPointArr.onClick {
            mBinding.mapView.setWorkMode(MapView.WorkMode.MODE_PATH_NODE_ATTR_EDIT)
        }

        // 合并路线
        mBinding.btnMergePath.onClick {
            mBinding.mapView.setWorkMode(MapView.WorkMode.MODE_PATH_MERGE)
        }

        // 删除路线
        mBinding.btnDeletePath.onClick {
            mBinding.mapView.setWorkMode(MapView.WorkMode.MODE_PATH_DELETE)
        }

        // 删除多条路线
        mBinding.btnDeleteMultiplePaths.onClick {
            mBinding.mapView.setWorkMode(MapView.WorkMode.MODE_PATH_DELETE_MULTIPLE)
        }

        // 曲线转直线
        mBinding.btnConvertPathToLine.onClick {
            mBinding.mapView.setWorkMode(MapView.WorkMode.MODE_PATH_CONVERT_TO_LINE)
        }

        // 创建路线
        mBinding.btnCreatePath.onClick {
            mBinding.mapView.setWorkMode(MapView.WorkMode.MODE_PATH_CREATE)
        }

        // 保存路线
        mBinding.btnSavePath.onClick {
            savePathsToFile()
        }


    }


    /**
     * 加载world_pad.dat文件中的路径数据
     */
    private fun readPathsFromFile() {
        lifecycleScope.launch {
            withContext(Dispatchers.IO) {
                try {
                    val filePath = ConstantBase.getFilePath(mapId, PAD_WORLD_NAME)
                    val file = File(filePath)
                    // 检查文件是否存在
                    if (file.exists()) {
                        //读取world_pad.dat
                        val readWorld = world.readWorld(getFolderPath(mapId), PAD_WORLD_NAME)
                        LogUtil.d("读取world_pad.dat ${readWorld}")
                        if (readWorld) mBinding.mapView.setLayer(world.cLayer)

                        withContext(Dispatchers.Main) {
                            dismissLoading()
                        }
                    } else {
                        LogUtil.d("路径数据文件不存在，将创建新的World对象")
                        world.saveWorld(getFolderPath(mapId), PAD_WORLD_NAME)
                    }
                } catch (e: NegativeArraySizeException) {
                    LogUtil.e("加载路径数据遇到NegativeArraySizeException: ${e}")
                    // 处理异常，例如创建一个新的World对象或显示错误信息
                    world.saveWorld(getFolderPath(mapId), PAD_WORLD_NAME)
                } catch (e: Exception) {
                    LogUtil.e("加载路径数据异常: ${e}")
                    e.printStackTrace()
                }
            }
        }
    }

    /**
     * 保存路线到world_pad.dat文件
     */
    private fun savePathsToFile() {
        showLoading("保存中")
        lifecycleScope.launch {
            withContext(Dispatchers.IO) {
                try {
//                    // 过滤起点和终点重合的路径
//                    filterPathsWithSameStartAndEnd()

                    val filePath = ConstantBase.getFilePath(mapId, PAD_WORLD_NAME)
                    val file = File(filePath)

                    // 创建保存目录（如果不存在）
                    val directory = file.parentFile
                    if (directory != null && !directory.exists()) {
                        directory.mkdirs()
                    }

                    // 调用World类的写入方法保存文件
                    if (world.saveWorld(getFolderPath(mapId), PAD_WORLD_NAME)) {
                        LogUtil.d("成功保存路径数据到文件: $filePath")
                        withContext(Dispatchers.Main) {
                            dismissLoading()
                        }
                    } else {
                        LogUtil.e("保存路径数据失败")
                    }

                } catch (e: Exception) {
                    LogUtil.e("保存路径数据异常: ${e.message}")
                    e.printStackTrace()
                }
            }
        }
    }

    /**
     * 过滤掉起点和终点重合的路径
     */
    private fun filterPathsWithSameStartAndEnd() {
        try {
            val pathBase = world.cLayer.m_PathBase
            if (pathBase == null || pathBase.m_pPathIdx == null || pathBase.m_uCount.toInt() == 0) {
                return
            }

            // 创建一个临时列表来存储需要保留的路径
            val validPaths = arrayListOf<PathIndex>()
            val epsilon = 1e-6f // 用于比较浮点数的小阈值

            for (i in 0 until pathBase.m_uCount) {
                val pathIndex = pathBase.m_pPathIdx[i]
                val path = pathIndex.m_ptr
                if (path == null) continue

                val startNode = path.GetStartNode()
                val endNode = path.GetEndNode()
                if (startNode == null || endNode == null) continue

                // 比较起点和终点的坐标是否重合
                val isSame =
                    Math.abs(startNode.x - endNode.x) < epsilon && Math.abs(startNode.y - endNode.y) < epsilon
                if (!isSame) {
                    validPaths.add(pathIndex)
                } else {
                    LogUtil.d("过滤掉起点和终点重合的路径: 路径ID=${path.m_uId}, 节点ID=${startNode.m_uId}")
                }
            }

            // 更新路径列表
            if (validPaths.size < pathBase.m_uCount) {
                val removedCount = pathBase.m_uCount - validPaths.size
                LogUtil.d("共过滤掉 $removedCount 条起点和终点重合的路径")

                // 创建新的路径索引数组
                pathBase.m_pPathIdx = validPaths.toTypedArray()
                pathBase.m_uCount = validPaths.size.toShort()
            }
        } catch (e: Exception) {
            LogUtil.e("过滤路径时发生异常: ${e.message}")
            e.printStackTrace()
        }
    }

    /**
     * 路径数据更改回调
     */
    fun onPathDataChanged() {
        LogUtil.d("路径数据已更改")
        // 可以在这里添加数据更改的通知逻辑
    }


    /**
     * 特殊区域
     */
    private fun initSpAreas() {
        mViewModel.getSpecialArea(mapId, 5) { list ->
            mSpArea.addAll(list)
            mBinding.mapView.setSpAreaData(mSpArea)
        }
        //添加特殊区域
        mBinding.btnAddSpArea.onClick {
            // 设置地图的工作模式为添加清扫区域模式
            mBinding.mapView.setWorkMode(MapView.WorkMode.MODE_SP_AREA_ADD)
            // 创建一个新的清扫区域
            val newArea = SpArea().apply {
                sub_name = "特殊区域${mSpArea.size + 1}"
                regId = mSpArea.size + 1
                layer_id = mapId
                routeType = 5
            }
            mSpArea.add(newArea)
            mBinding.mapView.createSpArea(newArea)
        }
        //编辑特殊区域
        mBinding.btnEditSpArea.onClick {
            if (mSpArea.isNotEmpty()) {
                // 生成0到positingAreas.size-1之间的随机索引
                val randomIndex = Random.nextInt(mSpArea.size)
                // 通过随机索引获取要删除的定位区域
                val randomArea = mSpArea[randomIndex]
                //切换特殊区域编辑模式
                mBinding.mapView.setWorkMode(MapView.WorkMode.MODE_SP_AREA_EDIT)
                mBinding.mapView.setSelectedSpArea(randomArea)
            }
        }

        // 设置特殊区域编辑监听器
        mBinding.mapView.setOnSpAreaEditListener(object : SpPolygonEditView.OnSpAreaEditListener {

            override fun onVertexDragEnd(area: SpArea, vertexIndex: Int) {
                LogUtil.i("编辑特殊区域onVertexDragEnd    ${area.toJson()}")
            }

            override fun onVertexAdded(area: SpArea, vertexIndex: Int, x: Float, y: Float) {
                LogUtil.i("编辑特殊区域onVertexAdded    ${area.toJson()}")
            }

            override fun onEdgeRemoved(area: SpArea, edgeIndex: Int) {
                LogUtil.i("编辑特殊区域onEdgeRemoved    ${area.toJson()}")
            }

            override fun onAreaCreated(area: SpArea) {
                LogUtil.i("创建了特殊新的清扫区域    ${area.toJson()}")
            }
        })

        //删除特殊区域
        mBinding.btnDeleteSpArea.onClick {
            // 随机选择一个定位区域进行删除
            if (mSpArea.isNotEmpty()) {
                // 生成0到positingAreas.size-1之间的随机索引
                val randomIndex = Random.nextInt(mSpArea.size)

                // 通过随机索引获取要删除的定位区域
                val randomArea = mSpArea[randomIndex]

                // 更新本地列表
                mSpArea.remove(randomArea)
                mBinding.mapView.setSpAreaData(mSpArea)
            }
        }
        //保存特殊区域
        mBinding.btnSaveSpArea.onClick {
            mViewModel.saveSpecialArea(mapId, mBinding.mapView.getSpAreaData())
        }

    }

    private fun initMixArea() {
        //获取混行区域
        mViewModel.getMixAreaData(mapId) { workAreasNew ->
            workAreasNew?.let {
                mMixArea.addAll(workAreasNew.workAreasList)
                mBinding.mapView.setMixAreaData(mMixArea)
            }
        }
        //添加混行区域
        mBinding.btnAddMixArea.onClick {
            // 设置地图的工作模式为添加清扫区域模式
            mBinding.mapView.setWorkMode(MapView.WorkMode.MODE_MIX_AREA_ADD)
            // 创建一个新的清扫区域
            val newArea = WorkAreasNew().apply {
                name = "混行区域${mMixArea.size + 1}"
                id = "${mMixArea.size + 1}"//随机申城
            }
            mMixArea.add(newArea)
            mBinding.mapView.createMixArea(newArea)
        }
        //编辑混行区
        mBinding.btnEditMixArea.onClick {
            if (mBinding.mapView.getMixAreaData().toMutableList().isNotEmpty()) {
                // 生成0到positingAreas.size-1之间的随机索引
                val randomIndex =
                    Random.nextInt(mBinding.mapView.getMixAreaData().toMutableList().size)

                // 通过随机索引获取要删除的定位区域
                val randomArea = mBinding.mapView.getMixAreaData().toMutableList()[randomIndex]

                // 设置地图的工作模式为编辑清扫区域模式
                mBinding.mapView.setWorkMode(MapView.WorkMode.MODE_MIX_AREA_EDIT)

                // 将选中的区域设置到PolygonEditView中进行编辑
                mBinding.mapView.setSelectedMixArea(randomArea)
            }
        }

        //设置混行区域编辑监听器
        mBinding.mapView.setOnMixAreaEditListener(object : MixAreaView.OnMixAreaEditListener {

            override fun onVertexDragEnd(area: WorkAreasNew, vertexIndex: Int) {
                LogUtil.i("编辑区域onVertexDragEnd   ${area.toJson()}")
            }

            override fun onVertexAdded(
                area: WorkAreasNew, vertexIndex: Int, x: Float, y: Float
            ) {
                LogUtil.i("编辑混行区域onVertexAdded   ${area.toJson()}")
            }

            override fun onEdgeRemoved(area: WorkAreasNew, edgeIndex: Int) {
                LogUtil.i("编辑混行区域onEdgeRemoved  ${area.toJson()}")
            }

            override fun onAreaCreated(area: WorkAreasNew) {
                LogUtil.i("创建了新的混行区域   ${area.toJson()}")
            }
        })
        //删除混行区域
        mBinding.btnDeleteMixArea.onClick {
            if (mMixArea.isNotEmpty()) {
                // 随机生成一个索引
                val randomIndex = Random.nextInt(mMixArea.size)
                // 删除随机选中的清扫区域
                mMixArea.removeAt(randomIndex)
                // 更新清扫区域数据
                mBinding.mapView.setMixAreaData(mMixArea)
                LogUtil.d("随机删除了一个清扫区域，当前剩余 ${cleanAreas.size} 个清扫区域")
            } else {
                LogUtil.d("没有清扫区域可以删除")
            }
        }
        //保存混行区
        mBinding.btnSaveMixArea.onClick {
            LogUtil.d("保存混行区 ${mBinding.mapView.getMixAreaData().toJson()}")

            mViewModel.saveAreaLiveDate
        }
    }

    /**
     * 充电站
     */
    private fun initMachineStation() {
        //加载充电站
        mViewModel.getMachineStation(onComplete = { machineStation ->
            LogUtil.d("获取充电站信息 $machineStation")
            val result = machineStation?.find { it.mapId == mapId }
            mBinding.mapView.setMachineStation(result)
        })
        //编辑充电站
        mBinding.btnEditChargeStation.onClick {
            mBinding.mapView.setWorkMode(MapView.WorkMode.MODE_MACHINE_STATION_EDIT)
        }

        //设置充电站点击监听器
        mBinding.mapView.setOnMachineStationClickListener(object :
            HomeDockView.OnMachineStationClickListener {
            override fun onMachineStationClick(
                station: com.siasun.dianshi.bean.MachineStation, type: Int
            ) {
                //处理充电站点击事件
                when (type) {
                    0 -> LogUtil.d("点击了对接点: $station")
                    1 -> LogUtil.d("点击了准备点: $station")
                    2 -> LogUtil.d("点击了等待点: $station")
                    3 -> LogUtil.d("点击了结束停放点: $station")
                }
                LogUtil.d("编辑充电站: $station, 类型: $type")
            }
        })

        //设置充电站删除监听器
        mBinding.mapView.setOnMachineStationDeleteListener(object :
            HomeDockView.OnMachineStationDeleteListener {
            override fun onMachineStationDelete(
                station: com.siasun.dianshi.bean.MachineStation, type: Int
            ) {
                //处理充电站删除事件
                when (type) {
                    0 -> LogUtil.d("删除了对接点: $station")
                    1 -> LogUtil.d("删除了准备点: $station")
                    2 -> LogUtil.d("删除了等待点: $station")
                    3 -> LogUtil.d("删除了结束停放点: $station")
                }
                LogUtil.d("删除充电站: $station, 类型: $type")

                // 这里可以添加实际的删除逻辑，比如网络请求删除该充电站点
            }
        })
        //删除充电站
        mBinding.btnDeleteChargeStation.onClick {
            mBinding.mapView.setWorkMode(MapView.WorkMode.MODE_MACHINE_STATION_DELETE)
        }
        //保存充电站
        mBinding.btnSaveChargeStation.onClick {
//            mBinding.mapView.getMachineStation()
        }
    }

    private fun initPose() {
        //加载上线点
        mViewModel.getInitPose(mapId, onComplete = { initPoses ->
            initPoses?.let {
                mBinding.mapView.setInitPoseList(it.Initposes)
            }
        })
    }

    /**
     * 加载顶视路线
     */
    private fun initMergedPose() {
        mViewModel.getMergedPose(mapId, onComplete = { mergedPoses ->
            mergedPoses?.data?.let {
                mBinding.mapView.setTopViewPathDada(it)
            }
        })
    }

    /**
     * 乘梯点
     */
    @RequiresApi(Build.VERSION_CODES.R)
    private fun initElevator() {
        //加载乘梯点
        mViewModel.getCmsElevator(mapId, onComplete = { elevatorPoint ->
            LogUtil.d("获取乘梯点 $elevatorPoint")
            mBinding.mapView.setElevators(elevatorPoint)
        })

        //添加
        mBinding.btnAddElevator.onClick {
            //弹框增加乘梯点
        }
        //编辑乘梯点
        mBinding.btnEditElevator.onClick {
            mBinding.mapView.setWorkMode(MapView.WorkMode.MODE_ELEVATOR_EDIT)
        }

        //删除乘梯点
        mBinding.btnDeleteElevator.onClick {
            mBinding.mapView.setWorkMode(MapView.WorkMode.MODE_ELEVATOR_DELETE)
        }

        //设置乘梯点编辑监听器
        mBinding.mapView.setOnElevatorEditListener(object :
            com.siasun.dianshi.view.ElevatorView.OnElevatorEditListener {
            override fun onElevatorEdit(elevator: com.siasun.dianshi.bean.ElevatorPoint) {
                //处理乘梯点编辑事件
                LogUtil.d("编辑乘梯点: $elevator")
            }
        })

        //设置乘梯点删除监听器
        mBinding.mapView.setOnElevatorDeleteListener(object :
            com.siasun.dianshi.view.ElevatorView.OnElevatorDeleteListener {
            override fun onElevatorDelete(elevator: com.siasun.dianshi.bean.ElevatorPoint) {
                //处理乘梯点删除事件
                LogUtil.d("删除乘梯点: $elevator")
            }
        })

        //保存乘梯点
        mBinding.btnDeleteElevator.onClick {
            //调接口保存乘梯点数据
        }
    }

    /**
     * 清扫区域
     */
    private fun initCleanArea() {
        //获取区域
        mViewModel.getAreaList(mapId, onComplete = { cleanAreasRoot ->
            cleanAreasRoot?.let {
                cleanAreas.addAll(it.cleanAreas)
                mBinding.mapView.setCleanAreaData(cleanAreas)
            }
        })
        //编辑清扫区域
        mBinding.btnEditArea.onClick {
            if (mBinding.mapView.getCleanAreaData().toMutableList().isNotEmpty()) {
                // 生成0到positingAreas.size-1之间的随机索引
                val randomIndex =
                    Random.nextInt(mBinding.mapView.getCleanAreaData().toMutableList().size)

                // 通过随机索引获取要删除的定位区域
                val randomArea = mBinding.mapView.getCleanAreaData().toMutableList()[randomIndex]

                // 设置地图的工作模式为编辑清扫区域模式
                mBinding.mapView.setWorkMode(MapView.WorkMode.MODE_CLEAN_AREA_EDIT)

                // 将选中的区域设置到PolygonEditView中进行编辑
                mBinding.mapView.setSelectedArea(randomArea)
            }
        }

        // 设置清扫区域编辑监听器
        mBinding.mapView.setOnCleanAreaEditListener(object :
            PolygonEditView.OnCleanAreaEditListener {

            override fun onVertexDragEnd(area: CleanAreaNew, vertexIndex: Int) {
                LogUtil.d("onVertexDragEnd area $area")
                if (area.routeType == AreaType.AREA_AUTO) {
                    MainController.sendRoutePathCommand(CLEAN_PATH_PLAN, area)
                    LogUtil.i(
                        "编辑区域onVertexDragEnd  申请路径规划 ${area.toJson()}", null, TAG_PP
                    )
                }
            }

            override fun onVertexAdded(
                area: CleanAreaNew, vertexIndex: Int, x: Float, y: Float
            ) {
                if (area.routeType == AreaType.AREA_AUTO) {
                    MainController.sendRoutePathCommand(CLEAN_PATH_PLAN, area)
                    LogUtil.i(
                        "编辑区域onVertexAdded  申请路径规划 ${area.toJson()}", null, TAG_PP
                    )
                }
            }

            override fun onEdgeRemoved(area: CleanAreaNew, edgeIndex: Int) {
                if (area.routeType == AreaType.AREA_AUTO) {
                    MainController.sendRoutePathCommand(CLEAN_PATH_PLAN, area)
                    LogUtil.i(
                        "编辑区域onEdgeRemoved  申请路径规划 ${area.toJson()}", null, TAG_PP
                    )
                }
            }

            override fun onAreaCreated(area: CleanAreaNew) {
                // 将新创建的清扫区域添加到本地列表
                LogUtil.d("创建了新的清扫区域: ${area.sub_name}, ID: ${area.regId}")
                if (area.routeType == AreaType.AREA_AUTO) {
                    MainController.sendRoutePathCommand(CLEAN_PATH_PLAN, area)
                    LogUtil.i("创建了新的清扫区域  申请路径规划 ${area.toJson()}", null, TAG_PP)
                }
            }
        })

        //添加清扫区域
        mBinding.btnAddArea.onClick {
            // 设置地图的工作模式为添加清扫区域模式
            mBinding.mapView.setWorkMode(MapView.WorkMode.MODE_CLEAN_AREA_ADD)
            // 创建一个新的清扫区域
            val newArea = CleanAreaNew().apply {
                sub_name = "清扫区域${cleanAreas.size + 1}"
                regId = cleanAreas.size + 1//随机申城
                layer_id = mapId
                routeType = 0 // 自动生成
                areaType = 1
                cleanShape = 3 // 回字型
                areaPathType = 0 // 普通清扫区域
            }
            cleanAreas.add(newArea)
            mBinding.mapView.createCleanArea(newArea)
        }

        //删除清扫区域
        mBinding.btnDeleteArea.onClick {
            if (cleanAreas.isNotEmpty()) {
                // 随机生成一个索引
                val randomIndex = Random.nextInt(cleanAreas.size)
                // 删除随机选中的清扫区域
                cleanAreas.removeAt(randomIndex)
                // 更新清扫区域数据
                mBinding.mapView.setCleanAreaData(cleanAreas)
                LogUtil.d("随机删除了一个清扫区域，当前剩余 ${cleanAreas.size} 个清扫区域")
            } else {
                LogUtil.d("没有清扫区域可以删除")
            }
        }
        //保存清扫区域
        mBinding.btnSaveArea.onClick {
            mViewModel.saveArea(mapId, cleanAreas)
        }
    }

    /**
     * 定位区域
     */
    private fun initPostingArea() {
        //创建定位区域
        mBinding.btnPostingAreaAdd.onClick {
            // 设置创建定位区域模式
            mBinding.mapView.setWorkMode(MapView.WorkMode.MODE_POSITING_AREA_ADD)
        }

        // 设置定位区域创建监听器
        mBinding.mapView.setOnPositingAreaCreatedListener(object :
            PostingAreasView.OnPositingAreaCreatedListener {
            override fun onPositingAreaCreated(area: PositingArea) {
                // 切换回移动模式
                mBinding.mapView.setWorkMode(MapView.WorkMode.MODE_SHOW_MAP)
            }
        })

        //编辑定位区域
        mBinding.btnPostingAreaEdit.setOnClickListener {
            // 随机选择一个定位区域高亮显示
            if (mBinding.mapView.getPositingAreas().toMutableList().isNotEmpty()) {
                mBinding.mapView.setWorkMode(MapView.WorkMode.MODE_POSITING_AREA_EDIT)

                // 生成0到positingAreas.size-1之间的随机索引
                val randomIndex =
                    Random.nextInt(mBinding.mapView.getPositingAreas().toMutableList().size)

                // 通过随机索引获取定位区域对象
                val randomArea = mBinding.mapView.getPositingAreas().toMutableList()[randomIndex]

                // 方式1：通过对象设置选中区域
                mBinding.mapView.setSelectedPositingArea(randomArea)

            }
        }

        //删除定位区域
        mBinding.btnPostingAreaDel.onClick {
            // 随机选择一个定位区域进行删除
            if (mBinding.mapView.getPositingAreas().toMutableList().isNotEmpty()) {
                // 生成0到positingAreas.size-1之间的随机索引
                val randomIndex =
                    Random.nextInt(mBinding.mapView.getPositingAreas().toMutableList().size)

                // 通过随机索引获取要删除的定位区域
                val randomArea = mBinding.mapView.getPositingAreas().toMutableList()[randomIndex]

                // 删除该定位区域
                mBinding.mapView.deletePositingArea(randomArea)

                // 更新本地列表
                mBinding.mapView.getPositingAreas().toMutableList().remove(randomArea)

                LogUtil.d("随机删除了定位区域: ${randomArea.id}")
            }
        }

        //保存定位区域
        mBinding.btnPostingAreaCommit.setOnClickListener {
            MainController.sendPositingArea(
                mapId, mBinding.mapView.getPositingAreas().toMutableList()
            )
        }
    }

    /**
     * 删除噪点
     */
    private fun initRemoveNoise() {
        //删除噪点
        mBinding.btnRemoveNoise.setOnClickListener {
            mBinding.mapView.setWorkMode(MapView.WorkMode.MODE_REMOVE_NOISE)
        }
        // 设置去除噪点监听器
        mBinding.mapView.setOnRemoveNoiseListener(object : MapView.IRemoveNoiseListener {
            override fun onRemoveNoise(leftTop: PointF, rightBottom: PointF) {
                // 处理噪点区域信息，这里可以添加日志或者发送到控制器
                LogUtil.d("去除噪点区域: 左上角(${leftTop.x}, ${leftTop.y}), 右下角(${rightBottom.x}, ${rightBottom.y})")
            }
        })
    }

    /**
     * 避让点
     */
    @RequiresApi(Build.VERSION_CODES.R)
    private fun initStation() {
        //加载避让点
        mViewModel.getStationData(mapId, onComplete = { cmsStations ->
            if (cmsStations != null) {
                cmsStation.addAll(cmsStations)
                mBinding.mapView.setCmsStations(cmsStation)
            }
        })
        //添加避让点
        mBinding.btnCreateStation.onClick {
            XpopUtils(this).showCmsStationDialog(
                onConfirmCall = { result ->
                    result?.let {
                        cmsStation.add(result)
                        mBinding.mapView.setCmsStations(cmsStation)
                    }

                }, onDeleteCall = {

                }, mapId
            )
        }
        //编辑避让点
        mBinding.btnEditStation.onClick {
            mBinding.mapView.setWorkMode(MapView.WorkMode.MODE_CMS_STATION_EDIT)
        }
        // 设置避让点点击监听器
        mBinding.mapView.setOnStationClickListener(object :
            com.siasun.dianshi.view.StationsView.OnStationClickListener {
            @RequiresApi(Build.VERSION_CODES.R)
            override fun onStationClick(station: CmsStation) {
                // 处理避让点点击事件
                LogUtil.d("点击了避让点: $station")
            }
        })
        //删除避让点
        mBinding.btnDeleteStation.onClick {
            mBinding.mapView.setWorkMode(MapView.WorkMode.MODE_CMS_STATION_DELETE)
        }

        // 设置避让点删除监听器
        mBinding.mapView.setOnStationDeleteListener(object :
            com.siasun.dianshi.view.StationsView.OnStationDeleteListener {
            override fun onStationDelete(station: CmsStation) {
                // 处理避让点删除事件
                LogUtil.d("删除了避让点: $station")
                // 这里可以添加删除避让点的业务逻辑，比如调用API删除服务器上的避让点
            }
        })
    }

    /**
     * 虚拟墙
     */
    private fun iniVirtualWall() {
        //加载虚拟墙
        mViewModel.getVirtualWall(mapId, onComplete = { virtualWall ->
            virtualWall?.let {
                mBinding.mapView.setVirtualWall(it)
            }
        })
        //添加虚拟墙
        mBinding.btnVirAdd.setOnClickListener {
            // 创建虚拟墙模式
            mBinding.mapView.setWorkMode(MapView.WorkMode.MODE_VIRTUAL_WALL_ADD)
            // 默认创建普通虚拟墙
            mBinding.mapView.addVirtualWall(3)
        }
        //编辑虚拟墙
        mBinding.btnVirEdit.setOnClickListener {
            // 编辑虚拟墙模式
            mBinding.mapView.setWorkMode(MapView.WorkMode.MODE_VIRTUAL_WALL_EDIT)

        }
        //删除虚拟墙
        mBinding.btnVirDel.setOnClickListener {
            // 删除虚拟墙模式
            mBinding.mapView.setWorkMode(MapView.WorkMode.MODE_VIRTUAL_WALL_DELETE)
        }
        //编辑虚拟墙类型
        mBinding.btnVirTypeEdit.setOnClickListener {
            // 编辑虚拟墙类型模式
            mBinding.mapView.setWorkMode(MapView.WorkMode.MODE_VIRTUAL_WALL_TYPE_EDIT)
        }
        // 设置虚拟墙点击监听器
        mBinding.mapView.setOnVirtualWallClickListener(object :
            VirtualWallView.OnVirtualWallClickListener {
            override fun onVirtualWallClick(lineIndex: Int, config: Int) {
                // 处理虚拟墙点击事件
                // 这里可以显示一个对话框，让用户选择新的虚拟墙类型
                Log.d(
                    "ShowMapViewActivity", "Virtual wall clicked: index=$lineIndex, config=$config"
                )

                // 示例：将虚拟墙类型切换为下一种类型 (1:重点虚拟墙, 2:虚拟门, 3:普通虚拟墙)
                val newConfig = when (config) {
                    1 -> 2
                    2 -> 3
                    else -> 1
                }

                // 更新虚拟墙类型
                mBinding.mapView.updateVirtualWallType(lineIndex, newConfig)
            }
        })
    }

    @RequiresApi(Build.VERSION_CODES.R)
    override fun onDestroy() {
        super.onDestroy()
        // 释放资源
//        mBinding.mapView.descendantFocusability()
    }

    @RequiresApi(Build.VERSION_CODES.R)
    override fun initData() {
        super.initData()
        MainController.sendGetPositingAreas(mapId)

        //上激光点云
        LiveEventBus.get<laser_t>(KEY_CURRENT_POINT_CLOUD).observe(this) {
            upRCData.ranges = it!!.ranges

//            mBinding.mapView.setUpLaserScan(it)
        }

        //下激光点云
        LiveEventBus.get<laser_t>(KEY_BOTTOM_CURRENT_POINT_CLOUD).observe(this) {

//            mBinding.mapView.setDownLaserScan(it)
        }

        //接收车体坐标 AGV->PAD
        LiveEventBus.get<robot_control_t>(KEY_AGV_COORDINATE).observe(this) {
            mBinding.mapView.setAgvPose(it)
            mBinding.mapView.setWorkingPath(it.dparams)

            //有任务才显示车体位置
//            if (RunningState.CURRENT_TASK_STATE == TaskState.HAVE_TASK) {
//                mBinding.mapView.setWorkingPath(it.dparams)
//            }
        }

        //接收导航定位区域
        LiveEventBus.get<String>(KEY_POSITING_AREA_VALUE).observe(this) {
            val positingAreas = GsonUtil.jsonToList(it, PositingArea::class.java)
            mBinding.mapView.setPositingAreas(positingAreas)
        }

//        //接收路径规划结果
//        LiveEventBus.get<PlanPathResult>(KEY_UPDATE_PLAN_PATH_RESULT).observe(this) { result ->
//            try {
//                // 检查路径段数量是否为0
//                if (result.m_iPathSum == 0) {
//                    LogUtil.i(
//                        "展示路径规划失败弹窗, 路径类型:${result.m_iPathPlanType}, 路段个数:${result.m_iPathSum}",
//                        null,
//                        TAG_PP
//                    )
//
//                    return@observe
//                }
//
//                // 检查路径点数量是否过大，防止内存溢出
//                if (result.m_fElementBuffer.size > PathPlanningUtil.MAX_POINT_COUNT) {
//                    LogUtil.e(
//                        "路径点数量过大，可能导致内存溢出: ${result.m_fElementBuffer.size}",
//                        null,
//                        TAG_PP
//                    )
//                    return@observe
//                }
//
//                // 检查当前内存状态，防止内存溢出
//                val memoryInfo = ActivityManager.MemoryInfo()
//                val activityManager = getSystemService(Context.ACTIVITY_SERVICE) as ActivityManager
//                activityManager.getMemoryInfo(memoryInfo)
//                if (memoryInfo.lowMemory) {
//                    // 内存不足时，清理旧路径和对象池
//                    LogUtil.w("系统内存不足，清理旧路径和对象池", null, TAG_PP)
//                    mBinding.mapView.clearPathPlan() // 假设MapView有清理路径的方法
//                    PathPlanningUtil.clearObjectPools() // 清理对象池
//                }
//
//                if (result.m_iPathPlanType == CLEAN_PATH_PLAN) {
//                    // 接收Pad申请的清扫路径规划结果
//                    if (result.m_strTo == "pad") {
//                        // 路段模式
//                        if (result.m_iPlanResultMode == PATH_MODE) {
//                            LogUtil.i(
//                                "AutoGeneratePathActivity接收清扫路径规划", null, TAG_PP
//                            )
//
//                            // 清除旧的清扫路径
//                            mBinding.mapView.clearCleanPathPlan()
//
//                            val cleanPathPlanResultBean =
//                                PathPlanningUtil.getPathPlanResultBean(result, mBinding.mapView)
//                            if (cleanPathPlanResultBean.m_bIsPlanOk) {
//                                mBinding.mapView.setCleanPathPlanResultBean(
//                                    cleanPathPlanResultBean
//                                )
//                            } else {
//                                LogUtil.e("清扫路径规划解析失败", null, TAG_PP)
//                            }
//                        }
//                    }
//                }
//                // 接收CMS申请的全局路径规划结果
//                if (result.m_iPathPlanType == GLOBAL_PATH_PLAN) {
//                    if (result.m_strTo == "CMS") {
//                        // 路段模式
//                        if (result.m_iPlanResultMode == PATH_MODE) {
//                            LogUtil.i(
//                                "CleanAutoActivity接收全局路径规划", null, TAG_PP
//                            )
//
//                            // 清除旧的全局路径
//                            mBinding.mapView.clearGlobalPathPlan()
//
//                            val globalPathPlanResultBean =
//                                PathPlanningUtil.getPathPlanResultBean(result)
//                            if (globalPathPlanResultBean.m_bIsPlanOk) {
//                                mBinding.mapView.setGlobalPathPlanResultBean(
//                                    globalPathPlanResultBean
//                                )
//                            } else {
//                                LogUtil.e("全局路径规划解析失败", null, TAG_PP)
//                            }
//                        }
//                    }
//                }
//            } catch (e: Exception) {
//                LogUtil.e(
//                    "接收路径规划异常: ${e.message}", null, TAG_PP
//                )
//                e.printStackTrace()
//                // 异常处理：清理可能已创建的资源
////                mBinding.mapView.clearPathPlan() // 清理所有路径
//                PathPlanningUtil.clearObjectPools() // 清理对象池
//            }
//        }
    }

    /**
     * 显示过门信息对话框
     */
    private fun showCrossDoorDialog(crossDoor: com.siasun.dianshi.bean.CrossDoor) {
        android.app.AlertDialog.Builder(this)
            .setTitle("过门信息")
            .setMessage(
                "ID: ${crossDoor.id}\n"
                        + "地图ID: ${crossDoor.map_id}\n"
                        + "门编号: ${crossDoor.door_msg.door_sn}\n"
                        + "类型: ${crossDoor.door_msg.type}\n"
                        + "起点: (${
                    String.format(
                        "%.2f",
                        crossDoor.start_point.x
                    )
                }, ${String.format("%.2f", crossDoor.start_point.y)})\n"
                        + "终点: (${
                    String.format(
                        "%.2f",
                        crossDoor.end_point.x
                    )
                }, ${String.format("%.2f", crossDoor.end_point.y)})"
            )
            .setPositiveButton("确定", null)
            .setNegativeButton("删除") { _, _ ->
                // 删除选中的过门
                mBinding.mapView.mCrossView?.removeCrossDoor(crossDoor)
                ToastUtils.showLong("已删除过门: ${crossDoor.door_msg.door_sn}")
            }
            .show()
    }
}